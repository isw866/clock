<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
<title>儿童钟表学习增强版</title>
<style>
body { margin:0; background:#f5f7fa; font-family:sans-serif; text-align:center; }
h2{ margin:8px 0 2px;}
.tip{ font-size:15px; color:#555;}
.star{ font-size:18px; margin:4px;}
.clock{ width:300px; height:300px; border:8px solid #333; border-radius:50%; margin:8px auto; position:relative; background:#fff; touch-action:none;}
.number{ position:absolute; font-size:18px; font-weight:bold;}
.hand{ position:absolute; left:50%; bottom:50%; transform-origin:bottom center; transition: transform 0.1s;}
.hour{ width:10px; height:80px; background:#ff6b6b; border-radius:5px;}
.minute{ width:8px; height:120px; background:#4dabf7; border-radius:4px;}
.hand.dragging{ transform: scale(1.2) translateX(-50%);}
.center{ width:16px; height:16px; background:#333; border-radius:50%; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);}
.star-animation{ position:absolute; font-size:24px; animation: rise 1s ease-out forwards; }
@keyframes rise{0%{opacity:1;transform:translate(-50%,0)}100%{opacity:0;transform:translate(-50%,-60px)}}
button{ padding:10px 16px; font-size:16px; border-radius:8px; border:none; background:#4dabf7; color:#fff;}
button.secondary{ background:#6c757d;}
</style>
</head>
<body>

<h2 id="levelTitle"></h2>
<div class="tip" id="levelTip"></div>
<div class="star" id="starText">⭐ 0</div>

<div class="clock" id="clock">
  <script>
    for(let i=1;i<=12;i++){
      document.write(`<div class="number" id="n${i}">${i}</div>`);
    }
  </script>
  <div class="hand hour" id="hourHand"></div>
  <div class="hand minute" id="minuteHand"></div>
  <div class="center"></div>
</div>

<div>
  <button onclick="speakTarget()">听一听</button>
  <button class="secondary" onclick="nextLevel()">下一关</button>
</div>

<script>
/* ===== 状态 ===== */
let level = 1;
let targetHour = 3, targetMinute = 0;
let hour = 12, minute = 0;
let dragging = null;
let stars = 0, solved = 0;

/* ===== DOM ===== */
const clock=document.getElementById('clock');
const hourHand=document.getElementById('hourHand');
const minuteHand=document.getElementById('minuteHand');
const levelTitle=document.getElementById('levelTitle');
const levelTip=document.getElementById('levelTip');
const starText=document.getElementById('starText');

/* ===== 布局数字 ===== */
(function layoutNumbers(){
  const r=130;
  for(let i=1;i<=12;i++){
    const a=(i-3)*30*Math.PI/180;
    document.getElementById('n'+i).style.cssText=`left:${150+r*Math.cos(a)-8}px;top:${150+r*Math.sin(a)-10}px`;
  }
})();

/* ===== 渲染 ===== */
function render(){
  hourHand.style.transform=`translateX(-50%) rotate(${(hour%12)*30+minute*0.5}deg)`;
  minuteHand.style.transform=`translateX(-50%) rotate(${minute*6}deg)`;
}

/* ===== 出题 ===== */
function newQuestion(){
  targetHour=Math.floor(Math.random()*12)+1;
  if(level===1) targetMinute=0;
  else targetMinute=Math.random()>0.5?30:0;

  switch(level){
    case 1: levelTitle.innerText='第 1 关：整点'; levelTip.innerText='听语音，把钟表拨对'; break;
    case 2: levelTitle.innerText='第 2 关：整点和半点'; levelTip.innerText='注意长针的位置'; break;
    case 3: levelTitle.innerText='第 3 关：听一听'; levelTip.innerText=''; break;
    case 4: levelTitle.innerText='第 4 关：挑战关'; levelTip.innerText='只靠记忆和理解'; break;
  }
  hour=Math.floor(Math.random()*12)+1;
  minute=Math.random()>0.5?30:0;
  render();
}

/* ===== 语音 ===== */
function speakTarget(){
  const u=new SpeechSynthesisUtterance(`请把钟表拨到 ${targetHour} 点${targetMinute===30?'半':''}`);
  u.lang='zh-CN';
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}

/* ===== 判断 ===== */
function checkAnswer(){
  if(hour===targetHour && minute===targetMinute){
    stars++; solved++;
    starText.innerText='⭐ '+stars;
    animateStar();
    const ok=new SpeechSynthesisUtterance('真棒');
    ok.lang='zh-CN'; speechSynthesis.speak(ok);
    if(solved>=5){
      solved=0;
      speechSynthesis.speak(new SpeechSynthesisUtterance('这一关完成了'));
    }
    flashHand();
    setTimeout(newQuestion,1200);
  }
}

/* ===== 星星动画 ===== */
function animateStar(){
  const star=document.createElement('div');
  star.className='star-animation';
  star.style.left='50%';
  star.style.top='20px';
  star.innerText='⭐';
  document.body.appendChild(star);
  setTimeout(()=>star.remove(),1000);
}

/* ===== 闪烁指针 ===== */
function flashHand(){
  hourHand.style.transition='transform 0.1s, background 0.2s';
  minuteHand.style.transition='transform 0.1s, background 0.2s';
  hourHand.style.background='#ff0';
  minuteHand.style.background='#ff0';
  setTimeout(()=>{ hourHand.style.background='#ff6b6b'; minuteHand.style.background='#4dabf7'; },300);
}

/* ===== 拖动优化 ===== */
function getAngle(x,y){
  const r=clock.getBoundingClientRect();
  return Math.atan2(y-(r.top+r.height/2),x-(r.left+r.width/2))*180/Math.PI +90;
}
function hitTest(hand,x,y){
  const rect=hand.getBoundingClientRect();
  return x>rect.left-25 && x<rect.right+25 && y>rect.top-25 && y<rect.bottom+25;
}

clock.addEventListener('pointerdown',e=>{
  if(hitTest(minuteHand,e.clientX,e.clientY)){ dragging='minute'; minuteHand.classList.add('dragging'); }
  else if(hitTest(hourHand,e.clientX,e.clientY)){ dragging='hour'; hourHand.classList.add('dragging'); }
});

clock.addEventListener('pointermove',e=>{
  if(!dragging) return;
  const a=getAngle(e.clientX,e.clientY);
  if(dragging==='minute') minute=a>180?30:0;
  else{ hour=Math.round(a/30); if(hour<=0)hour+=12; }
  render();
});

clock.addEventListener('pointerup',()=>{ dragging=null; hourHand.classList.remove('dragging'); minuteHand.classList.remove('dragging'); checkAnswer(); });
clock.addEventListener('pointerleave',()=>{ dragging=null; hourHand.classList.remove('dragging'); minuteHand.classList.remove('dragging'); });

/* ===== 切关 ===== */
function nextLevel(){ level=level===4?1:level+1; solved=0; newQuestion(); }

/* ===== 初始化 ===== */
newQuestion();
</script>
</body>
</html>
