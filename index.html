<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é’Ÿè¡¨å°èƒ½æ‰‹ - å®Œç¾é€‚é…ç‰ˆ</title>
    <style>
        :root {
            --bg: #FFF9E3; --primary: #FFD93D; --blue: #4A90E2; --red: #FF5E5E; --dark: #333;
        }
        body, html {
            margin: 0; padding: 0; 
            /* å…³é”®ä¿®å¤ï¼šè§£å†³æ‰‹æœºç«¯100vhåŒ…å«å·¥å…·æ çš„é—®é¢˜ */
            width: 100%; height: 100vh; height: 100svh; 
            font-family: 'PingFang SC', sans-serif; background: var(--bg);
            overflow: hidden; user-select: none; -webkit-user-select: none; touch-action: none;
        }
        .app { 
            display: flex; flex-direction: column; 
            height: 100vh; height: 100svh; /* ç¡®ä¿å®¹å™¨é«˜åº¦åŒæ­¥ */
        }
        
        .header { background: #fff; padding: 8px; display: flex; flex-direction: column; gap: 8px; border-bottom: 2px solid #EEE; z-index: 100; flex-shrink: 0; }
        .row { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; align-items: center; }
        .row::-webkit-scrollbar { display: none; }
        .btn-mode { padding: 6px 12px; border-radius: 15px; border: 2px solid var(--primary); background: #fff; font-size: 13px; white-space: nowrap; font-weight: bold; }
        .btn-mode.active { background: var(--primary); color: #855D00; }

        .switch-label { font-size: 11px; font-weight: bold; color: #666; display: flex; align-items: center; gap: 3px; }
        .toggle { width: 34px; height: 18px; background: #ddd; border-radius: 9px; position: relative; transition: .3s; }
        .toggle.on { background: #6BCB77; }
        .toggle::after { content: ''; position: absolute; width: 14px; height: 14px; background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: .3s; }
        .toggle.on::after { left: 18px; }

        .stage { 
            flex: 1; position: relative; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            overflow: hidden; /* é˜²æ­¢å†…å®¹æ’‘ç ´ */
        }
        
        .clock { 
            width: 260px; height: 260px; background: #fff; border-radius: 50%; 
            border: 10px solid var(--primary); position: relative; 
            box-shadow: 0 8px 0 #EBC22D; flex-shrink: 0; z-index: 1; 
        }
        .number { position: absolute; width: 36px; height: 36px; margin: -18px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 900; color: var(--dark); pointer-events: none; }

        .digital-clock {
            margin-top: 10px; background: #333; color: #00FF41; padding: 5px 15px;
            border-radius: 8px; font-family: 'Courier New', Courier, monospace;
            font-size: 24px; font-weight: bold; box-shadow: inset 0 0 10px #000;
            border: 3px solid #555; display: none;
        }

        #handsGroup { position: absolute; inset: 0; pointer-events: none; }
        .hand { position: absolute; bottom: 50%; left: 50%; transform-origin: bottom center; display: flex; flex-direction: column; align-items: center; }
        .arrow-head { width: 0; height: 0; border-left: 7px solid transparent; border-right: 7px solid transparent; margin-bottom: -2px; }
        
        .hour-hand { z-index: 3; }
        .hour-body { width: 10px; height: 60px; background: var(--blue); border-radius: 5px; border: 2px solid #fff; }
        .hour-arrow { border-bottom: 12px solid var(--blue); }
        
        .min-hand { z-index: 2; }
        .min-body { width: 7px; height: 90px; background: var(--red); border-radius: 4px; border: 1px solid #fff; }
        .min-arrow { border-bottom: 12px solid var(--red); border-left-width: 5px; border-right-width: 5px; }
        
        .sec-hand { z-index: 1; }
        .sec-body { width: 2px; height: 105px; background: #FF9F29; }
        
        .center-dot { position: absolute; width: 16px; height: 16px; background: var(--dark); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; border: 2px solid #fff; }

        #puzzleArea { width: 100%; height: 110px; position: relative; margin-top: 5px; }
        .puzzle-piece { position: absolute; width: 44px; height: 44px; background: #fff; border: 3px solid var(--blue); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--blue); font-weight: bold; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1); touch-action: none; }

        /* åº•éƒ¨é€‚é…ï¼šflex-shrink: 0 ä¿è¯ä¸è¢«å‹ç¼©ï¼Œpadding-bottom é€‚é…å…¨é¢å± */
        .footer { 
            background: #fff; padding: 10px 10px calc(15px + env(safe-area-inset-bottom)); 
            text-align: center; border-radius: 20px 20px 0 0; 
            box-shadow: 0 -5px 10px rgba(0,0,0,0.05); 
            flex-shrink: 0; 
        }
        .task-text { font-size: 28px; color: #FF9F29; font-weight: bold; margin: 3px 0; }
        .btn-check { 
            background: #6BCB77; color: #fff; border: none; 
            padding: 12px 60px; border-radius: 25px; 
            font-size: 18px; font-weight: bold; 
            box-shadow: 0 4px 0 #4EA858; 
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 200; }
    </style>
</head>
<body>

<div class="app">
    <div class="header">
        <div class="row" id="modeSelector">
            <button class="btn-mode active" data-mode="hour">æ•´ç‚¹ç»ƒä¹ </button>
            <button class="btn-mode" data-mode="half">åŠç‚¹ç»ƒä¹ </button>
            <button class="btn-mode" data-mode="puzzle">æ—¶é’Ÿæ‹¼å›¾</button>
            <button class="btn-mode" data-mode="free">è‡ªç”±æ¢ç´¢</button>
        </div>
        <div class="row">
            <div class="switch-label">ç§’é’ˆ <div class="toggle" id="secToggle"></div></div>
            <div class="switch-label">è”åŠ¨ <div class="toggle on" id="linkToggle"></div></div>
            <div class="switch-label">æ•°å­— <div class="toggle" id="digToggle"></div></div>
            <div class="switch-label">åŒæ­¥æ—¶é—´ <div class="toggle" id="liveToggle"></div></div>
        </div>
    </div>

    <div class="stage">
        <div class="clock" id="clockPlate">
            <div id="numbersContainer"></div>
            <div id="handsGroup">
                <div class="hand hour-hand" id="hourHand">
                    <div class="arrow-head hour-arrow"></div><div class="hour-body"></div>
                </div>
                <div class="hand min-hand" id="minHand">
                    <div class="arrow-head min-arrow"></div><div class="min-body"></div>
                </div>
                <div class="hand sec-hand" id="secHand" style="display:none">
                    <div class="sec-body"></div>
                </div>
            </div>
            <div class="center-dot"></div>
        </div>
        <div class="digital-clock" id="digClock">12:00:00</div>
        <div id="puzzleArea"></div>
    </div>

    <div class="footer" id="taskFooter">
        <div style="color:#888; font-size:12px;">å°æœ‹å‹ï¼Œè¯·æ‹¨åˆ°ï¼š</div>
        <div class="task-text" id="targetText">12ç‚¹æ•´</div>
        <button class="btn-check" id="checkBtn">æ‹¨å¥½å•¦ï¼</button>
    </div>
</div>

<div class="modal" id="winModal">
    <div style="background:#fff; padding:30px; border-radius:30px; text-align:center; width:70%">
        <div style="font-size:60px">ğŸŒŸ</div>
        <h2 style="color:#FF9F29">ä½ çœŸæ£’ï¼</h2>
        <button class="btn-check" id="nextBtn">ç»§ç»­æŒ‘æˆ˜</button>
    </div>
</div>

<script>
// æ­¤å¤„JSä»£ç é€»è¾‘ä¿æŒä¸å˜ï¼Œç¡®ä¿åŠŸèƒ½ç¨³å®š
const state = {
    h: 12, m: 0, s: 0,
    mode: 'hour',
    showSec: false, showDig: false, isLinked: true, isLive: false,
    targetH: 12, targetM: 0,
    puzzlePlaced: new Array(13).fill(false),
    activeHand: null, lastAngle: 0, liveTimer: null
};

const targetTextEl = document.getElementById('targetText');
const clockPlate = document.getElementById('clockPlate');
const hourEl = document.getElementById('hourHand');
const minEl = document.getElementById('minHand');
const secEl = document.getElementById('secHand');
const handsGroup = document.getElementById('handsGroup');
const digClock = document.getElementById('digClock');
const puzzleArea = document.getElementById('puzzleArea');

function say(text) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'zh-CN'; u.rate = 0.8; u.pitch = 1.2;
    window.speechSynthesis.speak(u);
}

function updateClockUI() {
    const secDeg = state.s * 6;
    const minDeg = state.m * 6 + (state.isLinked ? state.s * 0.1 : 0);
    const hourDeg = (state.h % 12) * 30 + (state.isLinked ? (state.m * 0.5 + state.s * (0.5/60)) : 0);
    secEl.style.transform = `translate(-50%, 0) rotate(${secDeg}deg)`;
    minEl.style.transform = `translate(-50%, 0) rotate(${minDeg}deg)`;
    hourEl.style.transform = `translate(-50%, 0) rotate(${hourDeg}deg)`;
    const pad = (n) => String(Math.floor(n)).padStart(2, '0');
    digClock.innerText = `${pad(state.h)}:${pad(state.m)}:${pad(state.s)}`;
}

function handleTouch(e) {
    if(state.mode === 'puzzle' || !e.touches[0]) return;
    if(state.isLive) stopLive();
    const rect = clockPlate.getBoundingClientRect();
    const cx = rect.left + rect.width/2, cy = rect.top + rect.height/2;
    const t = e.touches[0];
    let angle = Math.atan2(t.clientY - cy, t.clientX - cx) * 180 / Math.PI + 90;
    if(angle < 0) angle += 360;
    if(e.type === 'touchstart') {
        const dist = Math.hypot(t.clientX - cx, t.clientY - cy);
        if(state.showSec && dist > 100) state.activeHand = 'sec';
        else if(dist > 60) state.activeHand = 'min';
        else state.activeHand = 'hour';
        state.lastAngle = angle;
    } else if(e.type === 'touchmove') {
        e.preventDefault();
        let diff = angle - state.lastAngle;
        if(diff > 180) diff -= 360; if(diff < -180) diff += 360;
        const deltaSec = diff / 6;
        if(state.isLinked) {
            let total = state.h * 3600 + state.m * 60 + state.s;
            if(state.activeHand === 'sec') total += deltaSec;
            else if(state.activeHand === 'min') total += deltaSec * 60;
            else total += deltaSec * 3600;
            if(total < 0) total += 43200;
            total %= 43200;
            state.h = Math.floor(total / 3600) || 12;
            state.m = Math.floor((total % 3600) / 60);
            state.s = Math.floor(total % 60);
        } else {
            if(state.activeHand === 'sec') state.s = (state.s + deltaSec + 60) % 60;
            else if(state.activeHand === 'min') state.m = (state.m + deltaSec + 60) % 60;
            else { state.h = (state.h + deltaSec/30*2.5 + 12); state.h = state.h > 12 ? state.h - 12 : state.h; if(state.h <= 0) state.h += 12; }
        }
        state.lastAngle = angle;
        updateClockUI();
    } else if(e.type === 'touchend') {
        if(Math.floor(state.m) === 0 || Math.floor(state.m) === 30) say(`${Math.floor(state.h)}ç‚¹${Math.floor(state.m)===30?'åŠ':'æ•´'}`);
        state.activeHand = null;
    }
}

function initNumbers() {
    const container = document.getElementById('numbersContainer');
    container.innerHTML = '';
    for(let i=1; i<=12; i++) {
        if(state.mode === 'puzzle' && !state.puzzlePlaced[i]) continue;
        const div = document.createElement('div');
        div.className = 'number' + (state.mode === 'puzzle' ? ' placed' : '');
        const rad = (i * 30 - 90) * (Math.PI / 180);
        div.style.left = (130 + Math.cos(rad) * 105) + 'px';
        div.style.top = (130 + Math.sin(rad) * 105) + 'px';
        div.innerText = i;
        container.appendChild(div);
    }
}

function initPuzzle() {
    puzzleArea.innerHTML = '';
    const nums = [1,2,3,4,5,6,7,8,9,10,11,12].sort(() => Math.random()-0.5);
    const rows = 2, cols = 6;
    const cellW = puzzleArea.offsetWidth / cols;
    const cellH = puzzleArea.offsetHeight / rows;
    nums.forEach((n, i) => {
        const p = document.createElement('div');
        p.className = 'puzzle-piece'; p.innerText = n;
        const r = Math.floor(i/cols), c = i%cols;
        p.style.left = (c * cellW + 5) + 'px'; p.style.top = (r * cellH + 5) + 'px';
        let startX, startY, origL, origT;
        p.ontouchstart = (e) => { const t = e.touches[0]; startX = t.clientX; startY = t.clientY; origL = parseFloat(p.style.left); origT = parseFloat(p.style.top); };
        p.ontouchmove = (e) => { e.preventDefault(); const t = e.touches[0]; p.style.left = (origL + t.clientX - startX) + 'px'; p.style.top = (origT + t.clientY - startY) + 'px'; };
        p.ontouchend = () => {
            const rect = clockPlate.getBoundingClientRect();
            const cx = rect.left + rect.width/2, cy = rect.top + rect.height/2;
            const rad = (n * 30 - 90) * (Math.PI / 180);
            const tx = cx + Math.cos(rad) * 105, ty = cy + Math.sin(rad) * 105;
            const px = p.getBoundingClientRect().left + 22, py = p.getBoundingClientRect().top + 22;
            if(Math.hypot(px - tx, py - ty) < 45) { state.puzzlePlaced[n] = true; p.remove(); initNumbers(); say(n + "ç‚¹å½’ä½"); if(state.puzzlePlaced.filter(x=>x).length === 12) { document.getElementById('winModal').style.display = 'flex'; say("çœŸæ£’ï¼ä½ ä¿®å¥½äº†æ—¶é’Ÿï¼"); } }
        };
        puzzleArea.appendChild(p);
    });
}

function resetGame() {
    state.puzzlePlaced.fill(false);
    document.getElementById('winModal').style.display = 'none';
    puzzleArea.innerHTML = '';
    stopLive();
    state.h = 12; state.m = 0; state.s = 0;
    if(state.mode === 'puzzle') {
        handsGroup.style.display = 'none'; digClock.style.display = 'none';
        document.getElementById('taskFooter').style.visibility = 'hidden';
        initPuzzle();
    } else {
        handsGroup.style.display = 'block';
        digClock.style.display = state.showDig ? 'block' : 'none';
        document.getElementById('taskFooter').style.visibility = 'visible';
        state.targetH = Math.floor(Math.random()*12) + 1;
        state.targetM = state.mode === 'half' ? 30 : (state.mode === 'hour' ? 0 : (Math.random()>0.5?0:30));
        targetTextEl.innerText = `${state.targetH}ç‚¹${state.targetM === 30 ? 'åŠ' : 'æ•´'}`;
        say("è¯·æ‹¨åˆ°" + targetTextEl.innerText);
    }
    initNumbers(); updateClockUI();
}

function syncToLive() { const now = new Date(); state.h = now.getHours() % 12 || 12; state.m = now.getMinutes(); state.s = now.getSeconds(); updateClockUI(); }
function startLive() { state.isLive = true; document.getElementById('liveToggle').classList.add('on'); syncToLive(); state.liveTimer = setInterval(syncToLive, 1000); }
function stopLive() { state.isLive = false; document.getElementById('liveToggle').classList.remove('on'); clearInterval(state.liveTimer); }

clockPlate.addEventListener('touchstart', handleTouch);
clockPlate.addEventListener('touchmove', handleTouch);
clockPlate.addEventListener('touchend', handleTouch);

document.getElementById('modeSelector').onclick = (e) => {
    if(!e.target.classList.contains('btn-mode')) return;
    document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    state.mode = e.target.dataset.mode;
    resetGame();
};

document.getElementById('secToggle').onclick = function() { state.showSec = !state.showSec; this.classList.toggle('on'); secEl.style.display = state.showSec ? 'flex' : 'none'; };
document.getElementById('linkToggle').onclick = function() { state.isLinked = !state.isLinked; this.classList.toggle('on'); updateClockUI(); };
document.getElementById('digToggle').onclick = function() { state.showDig = !state.showDig; this.classList.toggle('on'); digClock.style.display = (state.showDig && state.mode !== 'puzzle') ? 'block' : 'none'; };
document.getElementById('liveToggle').onclick = function() { if(!state.isLive) startLive(); else stopLive(); };

document.getElementById('checkBtn').onclick = () => {
    const ok = (Math.floor(state.h) === state.targetH && Math.floor(state.m) === state.targetM);
    if(ok) { document.getElementById('winModal').style.display = 'flex'; say("å®Œå…¨æ­£ç¡®ï¼"); }
    else say("å†è¯•ä¸€æ¬¡å§");
};

document.getElementById('nextBtn').onclick = resetGame;
window.onload = resetGame;
</script>
</body>
</html>
